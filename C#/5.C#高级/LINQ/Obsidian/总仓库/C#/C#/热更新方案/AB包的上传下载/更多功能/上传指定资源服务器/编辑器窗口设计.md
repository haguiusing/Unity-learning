[D:\Obsidian Unity\Unity\HotUpdate\Assets\Editor\ABTools.cs](file:///d%3A/Obsidian%20Unity/Unity/HotUpdate/Assets/Editor/ABTools.cs)

![[Pasted image 20250602233636.png]]

实现一个 Unity 编辑器工具（`ABTools`），用于生成、管理和上传 AssetBundle（AB 包）及其对比文件。以下是对代码结构的详细解析：

### **1. 类定义与基本属性**
```csharp
public class ABTools : EditorWindow
```
- 继承自 `EditorWindow`，表示这是一个 Unity 编辑器窗口工具。
#### **基本属性**
```csharp
private int nowSelIndex = 0;
private string[] targetStrings = new string[] { "PC", "IOS", "Android" };
private string serverIP = "ftp://192.168.31.178";
```
- **`nowSelIndex`**：当前选择的平台索引（用于切换 PC、iOS 和 Android）。
- **`targetStrings`**：平台名称数组，用于 GUI 显示和路径选择。
- **`serverIP`**：FTP 服务器地址，用于上传 AB 包和对比文件。
### **2. 打开工具窗口**
```csharp
[MenuItem("AB包工具/打开工具窗口")]
private static void OpenWindow()
```
- **功能**：通过 Unity 菜单项（`MenuItem`）创建一个工具窗口。
- **实现**：调用 `EditorWindow.GetWindowWithRect` 创建一个指定大小的窗口，并显示。
### **3. GUI 绘制**
```csharp
private void OnGUI()
```
- **功能**：绘制编辑器窗口的界面。
- **内容**：
  1. **平台选择**：通过 `GUI.Toolbar` 显示平台选项（PC、iOS、Android）。
  2. **FTP 服务器地址输入框**：允许用户输入 FTP 服务器地址。
  3. **按钮功能**：
     - **“创建对比文件”**：调用 `CreateABCompareFile` 方法生成 AB 包对比文件。
     - **“将当前鼠标选中的资源保存到StreamingAssets”**：调用 `MoveABToStreamingAssets` 方法将选中的资源移动到 `StreamingAssets` 文件夹。
     - **“上传AB包和对比文件”**：调用 `UploadAllABFile` 方法上传 AB 包和对比文件到 FTP 服务器。
### **4. 创建对比文件**
```csharp
private void CreateABCompareFile()
```
- **功能**：生成 AB 包对比文件（`ABCompareInfo.txt`）。
- **实现**：
  1. 根据当前选择的平台（`targetStrings[nowSelIndex]`），获取对应的 AB 包文件夹路径。
  2. 遍历文件夹中的所有文件，筛选出没有后缀的文件（即 AB 包）。
  3. 对每个 AB 包，获取其文件名、大小和 MD5 值，并拼接为字符串（格式为 `文件名 文件大小 MD5|`）。
  4. 将拼接好的字符串保存到 `ABCompareInfo.txt` 文件中。
  5. 调用 `AssetDatabase.Refresh` 刷新编辑器资源。
### **5. 获取文件 MD5 值**
```csharp
private string GetMD5(string filePath)
```
- **功能**：计算文件的 MD5 值。
- **实现**：
  1. 使用 `FileStream` 打开文件。
  2. 使用 `MD5CryptoServiceProvider` 计算文件的 MD5 值（返回一个字节数组）。
  3. 将字节数组转换为 16 进制字符串。
### **6. 将选中资源移动到 StreamingAssets**
```csharp
private void MoveABToStreamingAssets()
```
- **功能**：将选中的资源移动到 `StreamingAssets` 文件夹，并生成默认资源的对比文件。
- **实现**：
  1. 使用 `Selection.GetFiltered` 获取在 Project 窗口中选中的资源。
  2. 遍历选中的资源，筛选出没有后缀的文件（即 AB 包）。
  3. 使用 `AssetDatabase.CopyAsset` 将资源复制到 `StreamingAssets` 文件夹。
  4. 获取复制后的文件信息，生成对比文件内容（格式与 `CreateABCompareFile` 相同）。
  5. 将对比文件内容保存到 `StreamingAssets/ABCompareInfo.txt`。
  6. 调用 `AssetDatabase.Refresh` 刷新编辑器资源。
### **7. 上传 AB 包和对比文件**
```csharp
private void UploadAllABFile()
```
- **功能**：将指定平台的 AB 包和对比文件上传到 FTP 服务器。
- **实现**：
  1. 根据当前选择的平台，获取对应的 AB 包文件夹路径。
  2. 遍历文件夹中的所有文件，筛选出没有后缀的文件（即 AB 包）和 `.txt` 文件（对比文件）。
  3. 调用 `FtpUploadFile` 方法上传每个文件。
### **8. 异步上传文件**
```csharp
private async void FtpUploadFile(string filePath, string fileName)
```
- **功能**：异步上传文件到 FTP 服务器。
- **实现**：
  1. 使用 `FtpWebRequest` 创建 FTP 请求。
  2. 设置 FTP 请求的凭证、代理、传输模式等。
  3. 使用 `FileStream` 读取本地文件内容，并分块写入 FTP 请求流。
  4. 上传完成后，关闭流并记录日志。
### **代码结构总结**
1. **工具窗口**：通过 `EditorWindow` 创建一个编辑器工具窗口，提供用户界面。
2. **功能模块**：
   - **平台选择**：允许用户选择目标平台（PC、iOS、Android）。
   - **FTP 地址设置**：允许用户输入 FTP 服务器地址。
   - **生成对比文件**：生成 AB 包对比文件（`ABCompareInfo.txt`）。
   - **移动资源到 StreamingAssets**：将选中的资源复制到 `StreamingAssets` 文件夹，并生成默认资源的对比文件。
   - **上传文件**：将 AB 包和对比文件上传到 FTP 服务器。
3. **辅助功能**：
   - **MD5 计算**：用于生成文件的 MD5 值，用于资源对比。
   - **异步上传**：使用异步方式上传文件，避免阻塞编辑器主线程。
### **改进建议**
1. **异常处理**：
   - 在文件操作和网络请求中增加异常处理，避免程序崩溃。
   - 例如，在 `FtpUploadFile` 中捕获异常并记录详细日志。

2. **用户反馈**：
   - 在操作过程中（如上传文件、生成对比文件）提供进度条或日志输出，让用户了解当前状态。

3. **配置化**：
   - 将 FTP 服务器地址、用户名和密码等配置信息提取到配置文件中，避免硬编码。

4. **优化 GUI**：
   - 使用 `GUILayout` 或 `EditorGUILayout` 替代 `GUI`，简化布局代码。

5. **异步改进**：
   - 将 `FtpUploadFile` 的返回类型改为 `Task`，并让调用者通过 `await` 等待完成。