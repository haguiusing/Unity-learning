[[创建AB包下载管理器脚本]]
[[下载资源对比文件]]
[[下载AB包]]


基于 Unity 的资源热更新管理器（`ABUpdateMgr`），用于检查和更新 AssetBundle（AB 包）。以下是代码的结构和主要功能模块的详细解析：
### **1. 单例模式**
```csharp
private static ABUpdateMgr instance;
public static ABUpdateMgr Instance { get { ... } }
```
- 使用单例模式确保全局只有一个 `ABUpdateMgr` 实例。
- 如果实例不存在，会自动创建一个新的 GameObject 并附加该脚本。
### **2. 数据结构**
```csharp
private Dictionary<string, ABInfo> remoteABInfo = new Dictionary<string, ABInfo>();
private Dictionary<string, ABInfo> localABInfo = new Dictionary<string, ABInfo>();
private List<string> downLoadList = new List<string>();
private string serverIP = "ftp://192.168.31.178";
```
- **`remoteABInfo`**：存储远端服务器上的 AB 包信息（名称、大小、MD5）。
- **`localABInfo`**：存储本地已有的 AB 包信息。
- **`downLoadList`**：存储需要下载的 AB 包名称列表。
- **`serverIP`**：资源服务器的地址。
### **3. 主要功能：检查更新**
```csharp
public void CheckUpdate(UnityAction<bool> overCallBack, UnityAction<string> updateInfoCallBack)
```
- **功能**：检查是否有新的 AB 包需要下载或更新。
- **步骤**：
  1. **下载远端资源对比文件**：通过 `DownLoadABCompareFile` 方法从服务器下载最新的资源对比文件（`ABCompareInfo.txt`）。
  2. **解析远端对比文件**：调用 `GetRemoteABCompareFileInfo` 方法，将下载的对比文件内容解析为字典存储到 `remoteABInfo`。
  3. **加载本地资源对比文件**：调用 `GetLocalABCompareFileInfo` 方法，加载本地的资源对比文件（`ABCompareInfo.txt`），并解析到 `localABInfo`。
  4. **对比远端和本地信息**：
     - 如果远端有本地没有的 AB 包，加入 `downLoadList`。
     - 如果远端和本地的 AB 包 MD5 不一致，加入 `downLoadList`。
     - 如果本地有远端没有的 AB 包，删除本地的多余文件。
  5. **下载待更新的 AB 包**：调用 `DownLoadABFile` 方法下载 `downLoadList` 中的 AB 包。
  6. **更新本地对比文件**：下载完成后，将远端的对比文件内容覆盖本地的对比文件。
### **4. 下载远端资源对比文件**
```csharp
public async void DownLoadABCompareFile(UnityAction<bool> overCallBack)
```
- **功能**：从服务器下载资源对比文件（`ABCompareInfo.txt`）。
- **实现**：
  - 使用 `FtpWebRequest` 从 FTP 服务器下载文件。
  - 将下载的文件保存到本地临时路径（`Application.persistentDataPath + "/ABCompareInfo_TMP.txt"`）。
  - 如果下载失败，会尝试重新下载最多 5 次。
### **5. 解析对比文件**
```csharp
public void GetRemoteABCompareFileInfo(string info, Dictionary<string, ABInfo> ABInfo)
```
- **功能**：解析对比文件的内容。
- **格式**：假设对比文件内容格式为 `AB包名 MD5 文件大小|`，例如：
  ```
  bundle1 abcd1234 1024|bundle2 efgh5678 2048|
  ```
- **解析**：
  - 使用 `|` 分割每一行，获取每个 AB 包的信息。
  - 使用空格分割每个 AB 包的详细信息（名称、MD5、大小）。
  - 将解析后的信息存储到字典中。
### **6. 加载本地资源对比文件**
```csharp
public void GetLocalABCompareFileInfo(UnityAction<bool> overCallBack)
```
- **功能**：加载本地的资源对比文件。
- **实现**：
  - 优先从 `Application.persistentDataPath` 加载对比文件。
  - 如果不存在，则从 `Application.streamingAssetsPath` 加载默认资源。
  - 使用 `UnityWebRequest` 加载文件内容并解析。
### **7. 下载 AB 包**
```csharp
public async void DownLoadABFile(UnityAction<bool> overCallBack, UnityAction<string> updatePro)
```
- **功能**：下载 `downLoadList` 中的 AB 包。
- **实现**：
  - 遍历 `downLoadList`，逐个下载 AB 包。
  - 使用 `FtpWebRequest` 从 FTP 服务器下载文件。
  - 如果下载失败，会尝试重新下载最多 5 次。
  - 下载完成后，将成功下载的 AB 包从 `downLoadList` 中移除。
### **8. 下载文件**
```csharp
private bool DownLoadFile(string fileName, string localPath)
```
- **功能**：下载单个文件。
- **实现**：
  - 使用 `FtpWebRequest` 连接到 FTP 服务器并请求下载文件。
  - 将下载的文件内容写入本地路径。
  - 如果下载成功，返回 `true`；否则返回 `false`。
### **9. AB 包信息类**
```csharp
public class ABInfo
{
    public string name;
    public long size;
    public string md5;

    public ABInfo(string name, string size, string md5)
    {
        this.name = name;
        this.size = long.Parse(size);
        this.md5 = md5;
    }
}
```
- **功能**：存储 AB 包的名称、大小和 MD5 值。
### **10. 生命周期管理**
```csharp
private void OnDestroy()
{
    instance = null;
}
```
- **功能**：销毁时清理单例。

---

### **代码结构总结**
1. **单例模式**：确保全局只有一个实例。
2. **数据结构**：使用字典存储远端和本地的 AB 包信息，使用列表存储待下载的 AB 包。
3. **主功能**：通过 `CheckUpdate` 方法实现完整的更新流程。
4. **下载模块**：通过 `DownLoadABCompareFile` 和 `DownLoadABFile` 方法实现文件下载。
5. **解析模块**：通过 `GetRemoteABCompareFileInfo` 和 `GetLocalABCompareFileInfo` 方法解析对比文件。
6. **辅助类**：`ABInfo` 类用于存储 AB 包的详细信息。
### **改进建议**
1. **错误处理**：增加更详细的错误日志，方便调试。
2. **异步改进**：将 `DownLoadFile` 方法改为异步，避免阻塞主线程。
3. **进度反馈**：在下载过程中提供更详细的进度反馈。
4. **配置化**：将服务器地址、用户名和密码等配置信息提取到配置文件中，方便修改。

