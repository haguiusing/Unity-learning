[Lua 文件 I/O | 菜鸟教程](https://www.runoob.com/lua/lua-file-io.html)
[Lua 的 I/O 库提供了哪些函数？-JavaScript中文网-JavaScript教程资源分享门户](https://www.javascriptcn.com/interview-lua/677f4cae6f8688f8e9faf2b2.html)
[6.8 - I/O操作 | Lua 5.4 中文参考手册](https://atom-l.github.io/lua5.4-manual-zh/6.8.html)

Lua I/O 库用于读取和处理文件。分为简单模式（和C一样）、完全模式。
- 简单模式（simple model）拥有一个当前输入文件和一个当前输出文件，并且提供针对这些文件相关的操作。
- 完全模式（complete model） 使用外部的文件句柄来实现。它以一种面对对象的形式，将所有的文件操作定义为文件句柄的方法

## 简单模式_隐式的文件句柄
即有些操作可以设置默认的输入文件和输出文件，并且所有的I/O操作都会使用这些默认文件来执行。当使用隐式的文件句柄时，其所有的操作都由表 io 提供。
简单模式在做一些简单的文件操作时较为合适。但是在进行一些高级的文件操作的时候，简单模式就显得力不从心。例如同时读取多个文件这样的操作，使用完全模式则较为合适。

```lua
-- 以只读方式打开文件
file = io.open("test.lua", "r")

-- 设置默认输入文件为 test.lua
io.input(file)

-- 输出文件第一行
print(io.read())

-- 关闭打开的文件
io.close(file)

-- 以附加的方式打开只写文件
file = io.open("test.lua", "a")

-- 设置默认输出文件为 test.lua
io.output(file)

-- 在文件最后一行添加 Lua 注释
io.write("--  test.lua 文件末尾注释")

-- 关闭打开的文件
io.close(file)
```

输出了 test.lua 文件的第一行信息，并在该文件最后一行添加了 lua 的注释。
```lua
-- test.lua 文件
```

### io.open(filename\[, mode\])
- **功能**：打开一个文件并返回文件句柄。
- **参数**：
    - `filename`：要打开的文件名。
    - `mode`：打开模式，如 `"r"`（只读）、`"w"`（写入）、`"a"`（追加）等。
- **返回值**：成功时返回文件句柄，失败时返回 `nil` 和错误信息。

mode 的值有：

| 模式  | 描述                                                                    |
| --- | --------------------------------------------------------------------- |
| r   | 以只读方式打开文件，该文件必须存在。                                                    |
| w   | 打开只写文件，若文件存在则文件长度清为0，即该文件内容会消失。若文件不存在则建立该文件。                          |
| a   | 以附加的方式打开只写文件。若文件不存在，则会建立该文件，如果文件存在，写入的数据会被加到文件尾，即文件原先的内容会被保留。（EOF符保留） |
| r+  | 以可读写方式打开文件，该文件必须存在。                                                   |
| w+  | 打开可读写文件，若文件存在则文件长度清为零，即该文件内容会消失。若文件不存在则建立该文件。                         |
| a+  | 与a类似，但此文件可读可写                                                         |
| b   | 二进制模式，如果文件是二进制文件，可以加上b                                                |
| +   | 号表示对文件既可以读也可以写                                                        |
### io.close(\[file\])
- **功能**：关闭文件句柄。
- **参数**：
    - `file`：可选参数，指定要关闭的文件句柄。如果省略，则关闭默认输出文件。
- **返回值**：无。

### io.read(...)
- **功能**：从标准输入或文件中读取数据。
- **参数**：可变参数，指定读取格式，如 `"*n"`（读取数字）、`"*a"`（读取所有内容）等。
- **返回值**：读取到的数据。

|模式|描述|
|---|---|
|"*n"|读取一个数字并返回它。例：file.read("*n")|
|"*a"|从当前位置读取整个文件。例：file.read("*a")|
|"*l"（默认）|读取下一行，在文件尾 (EOF) 处返回 nil。例：file.read("*l")|
|number|返回一个指定字符个数的字符串，或在 EOF 时返回 nil。例：file.read(5)|

### io.write(...)
- **功能**：向标准输出或文件中写入数据。
- **参数**：可变参数，指定要写入的数据。
- **返回值**：无。

### io.flush(\[file\])
- **功能**：刷新输出缓冲区。等效于 io.output():flush() 。
- **参数**：
    - `file`：可选参数，指定要刷新的文件句柄。如果省略，则刷新默认输出文件。
- **返回值**：无。

### io.lines(\[filename\])
- **功能**：返回一个迭代器，用于逐行读取文件。
- **参数**：
    - `filename`：可选参数，指定要读取的文件名。如果省略，则从标准输入读取。
- **返回值**：迭代器函数。

### io.input(\[file\])
- **功能**：设置默认输入文件。
- **参数**：
    - `file`：可选参数，指定要设置为默认输入的文件句柄或文件名。如果省略，则返回当前默认输入文件。
- **返回值**：当前默认输入文件句柄。

### io.output(\[file\])
- **功能**：设置默认输出文件。
- **参数**：
    - `file`：可选参数，指定要设置为默认输出的文件句柄或文件名。如果省略，则返回当前默认输出文件。
- **返回值**：当前默认输出文件句柄。

### io.tmpfile()
- **功能**：创建一个临时文件并返回文件句柄。
- **参数**：无。
- **返回值**：临时文件的文件句柄。

### io.type(obj)
- **功能**：检查对象是否为有效的文件句柄。
- **参数**：
    - `obj`：要检查的对象。
- **返回值**：如果 `obj` 是文件句柄，则返回 `"file"`；否则返回 `nil`。

## 完全模式_显式的文件句柄
使用显式的文件句柄时，[io.open](https://atom-l.github.io/lua5.4-manual-zh/6.8.html#io.open)操作会返回一个文件句柄，该文件句柄(File)中的方法提供了相关操作。

当文件句柄关闭时，会尝试调用其元表中的 __gc 和 __close 元方法。

io 表中还提供了三个预定义的文件句柄：io.stdin、io.stdout、和 io.stderr，其和C代码中的用法含义相同。I/O库永远不会关闭这几个文件。

除非另有说明，所有的I/O函数都会在失败的时候返回**fail**，再加上一个错误信息作为第二个返回值以及系统相关的错误码作为第三个返回值。在非POSIX系统中，在发生错误的时对错误消息和错误码的计算可能不是线程安全的，因为其由C代码中的全局变量 errno 而来。

通常我们需要在同一时间处理多个文件。我们需要使用 file:function_name 来代替 io.function_name 方法。以下实例演示了如何同时处理同一个文件:
```lua
-- 以只读方式打开文件  
file = io.open("test.lua", "r")  
  
-- 输出文件第一行  
print(file:read())  
  
-- 关闭打开的文件  
file:close()  
  
-- 以附加的方式打开只写文件  
file = io.open("test.lua", "a")  
  
-- 在文件最后一行添加 Lua 注释  
file:write("--test")  
  
-- 关闭打开的文件  
file:close()  
```

输出了 test.lua 文件的第一行信息，并在该文件最后一行添加了 lua 的注释
```lua
-- test.lua 文件
```

### file:close ()[​](https://atom-l.github.io/lua5.4-manual-zh/6.8.html#file:close)
关闭文件 file 。注意文件会在其句柄被GC后自动关闭，但其关闭的时刻是不确定的。

当关闭一个由[io.popen](https://atom-l.github.io/lua5.4-manual-zh/6.8.html#io.popen)创建的文件句柄时，[file:close](https://atom-l.github.io/lua5.4-manual-zh/6.8.html#file:close)会使用[os.execute](https://atom-l.github.io/lua5.4-manual-zh/6.8.html#os.execute)的返回值。

### file:flush ()[​](https://atom-l.github.io/lua5.4-manual-zh/6.8.html#file:flush)
将数据保存到文件 file 中。

### file:lines (···)[​](https://atom-l.github.io/lua5.4-manual-zh/6.8.html#file:lines)
返回一个迭代器函数，其每次调用都会按照给出的格式来读文件。如果没有给出格式，则默认使用 "l" 。例如：

for c in file:lines(1) do _body_ end

这样的代码将会从当前位置遍历文件的所有字符。与[io.lines](https://atom-l.github.io/lua5.4-manual-zh/6.8.html#io.lines)不同，该函数不会在循环结束后关闭文件。

### file:read (···)[​](https://atom-l.github.io/lua5.4-manual-zh/6.8.html#file:read)
按照给出的格式读取文件 file 的指定内容。对于每种格式，该函数会返回所读取的字符串或数字，或者不能按照指定格式读取数据时返回**fail**。（在后边的情况中，该函数不会读取后续的格式。）当不传入参数调用时，会使用默认的格式来读取下一行（如下所示）。

可用的格式有：
- **"n"：** 读取一个数字并作为整数或浮点数返回，其遵循Lua的词法规则。（数字前边可能有空格和符号。）该模式总是读取尽可能长的数字序列；如果没有有效的数字前缀（如，空字符串、"0x"、或者"3.4e-"）或者实在太长（超过200个字符），则会放弃读取并返回**fail**。
- **"a"：** 从当前位置读取整个文件。如果当前位置在文件末尾，则会返回一个空字符串，该格式永远不会失败。
- **"l"：** 读取下一行并忽略换行符，到达文件末尾时会返回**fail**。这是默认的读取格式。
- **"L"：** 读取下一行并保留换行符（如果有的话），到达文件末尾时会返回**fail**。
- **_number_：** 读取若干字节的字符串，到达文件末尾时会返回**fail**。如果 number 为零，则什么都不会读取并返回空字符串，或者刚好在文件末尾时返回**fail**。

"l" 和 "L" 格式只能对文本文件使用。

### file:seek ([whence [, offset]])[​](https://atom-l.github.io/lua5.4-manual-zh/6.8.html#file:seek)
设置并获取文件位置，所返回的位置表示为相对于文件开头偏移，而给出的位置由基于字符串参数 whence 所指的的位置的偏移 offset ，whence 字符串内容可选：
- **"set"：** 基于零点位置（文件开头）。
- **"cur"：** 基于当前位置。
- **"end"：** 基于文件末尾。

成功的情况下，seek 会返回最终的文件位置，其表示为为相对于文件开头的字节偏移量。如果 seek 失败了，则返回**fail**，以及描述错误的字符串。

参数 whence 默认为 "cur"，offset 默认为0。因此，执行 file:seek() 会返回当前的文件位置而不会改变它；执行 file:seek("set") 会将当前位置设置到文件开头（并返回0）；执行 file:seek("end") 会将当前位置设置到文件末尾并返回文件的大小。

### file:setvbuf (mode [, size])[​](https://atom-l.github.io/lua5.4-manual-zh/6.8.html#file:setvbuf)
设置文件的缓冲模式。有三种可用模式：
- **"no"：** 无缓冲。
- **"full"：** 全缓冲。
- **"line"：** 行缓冲。

对于后两种情况，size 用于指定缓冲区字节大小。其默认是个适当的大小（目前源码中是一个预定义的值，其为 16 X 所处平台的指针大小 X [lua_Number](https://atom-l.github.io/lua5.4-manual-zh/4.6.html#lua_Number)大小，一般为1024，即1KB）。

每种模式所指的具体行为是不可移植的，更多细节请查看所处平台的ISO标准C中的 setvbuf 函数。

### file:write (···)[​](https://atom-l.github.io/lua5.4-manual-zh/6.8.html#file:write)
将接收到的每个参数都写入到文件 file 中。所传参数必须是字符串或数字。

成功的情况下，该函数返回 file 本身。