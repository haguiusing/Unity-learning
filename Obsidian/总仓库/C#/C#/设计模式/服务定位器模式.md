## 服务定位器模式
服务定位器模式（Service Locator Pattern）用在我们想使用 JNDI 查询定位各种服务的时候。考虑到为某个服务查找 JNDI 的代价很高，服务定位器模式充分利用了缓存技术。在首次请求某个服务时，服务定位器在 JNDI 中查找服务，并缓存该服务对象。当再次请求相同的服务时，服务定位器会在它的缓存中查找，这样可以在很大程度上提高应用程序的性能。以下是这种设计模式的实体。
- **服务（Service）** - 实际处理请求的服务。对这种服务的引用可以在 JNDI 服务器中查找到。
- **Context / 初始的 Context** - JNDI Context 带有对要查找的服务的引用。
- **服务定位器（Service Locator）** - 服务定位器是通过 JNDI 查找和缓存服务来获取服务的单点接触。
- **缓存（Cache）** - 缓存存储服务的引用，以便复用它们。
- **客户端（Client）** - Client 是通过 ServiceLocator 调用服务的对象。

模式结构：
- Service Locator Interface：服务定位器接口
- Service Locator Implementation：服务定位器实现
- Service Interface：服务接口
- Concrete Service：具体服务
- Client：客户端

包含的几个主要角色
1. **服务定位器接口（Service Locator Interface）**：
    - 定义获取服务的方法。
2. **服务定位器实现（Service Locator Implementation）**：
    - 实现服务定位器接口，封装服务的查找和访问逻辑。
3. **服务接口（Service Interface）**：
    - 定义服务的抽象表示。
4. **具体服务（Concrete Service）**：
    - 实现服务接口，提供具体的服务功能。
5. **客户端（Client）**：
    - 使用服务定位器来访问所需的服务。

![[20201015-service-locator.svg]]

1. `IService` 接口：服务接口，定义了服务的基本方法
2. `Service1` 和 `Service2` 类：具体服务，实现了 `IService` 接口并提供了具体的服务逻辑
3. `InitialContext` 类：JNDI 查询类，负责创建具体的服务实例
4. `Cache` 类：缓存类，负责缓存服务实例以提高性能
5. `ServiceLocator` 类：服务定位器实现，负责从缓存或 JNDI 中获取服务实例
6. `ServiceLocatorPatternDemo` 类：客户端，演示如何使用服务定位器模式

```cs
using System;
using System.Collections.Generic;

// Service Interface：服务接口
public interface IService
{
    string GetName();
    void Execute();
}

// Concrete Service：具体服务
// Service1类
public class Service1 : IService
{
    public void Execute()
    {
        Console.WriteLine("Executing Service1");
    }

    public string GetName()
    {
        return "Service1";
    }
}

// Service2类
public class Service2 : IService
{
    public void Execute()
    {
        Console.WriteLine("Executing Service2");
    }

    public string GetName()
    {
        return "Service2";
    }
}

// InitialContext：为JNDI查询创建InitialContext
public class InitialContext
{
    public object Lookup(string jndiName)
    {
        if (jndiName.Equals("SERVICE1", StringComparison.OrdinalIgnoreCase))
        {
            Console.WriteLine("Looking up and creating a new Service1 object");
            return new Service1();
        }
        else if (jndiName.Equals("SERVICE2", StringComparison.OrdinalIgnoreCase))
        {
            Console.WriteLine("Looking up and creating a new Service2 object");
            return new Service2();
        }
        return null;
    }
}

// Cache：创建缓存
public class Cache
{
    private List<IService> services = new List<IService>();

    public Cache()
    {
    }

    public IService GetService(string serviceName)
    {
        foreach (IService service in services)
        {
            if (service.GetName().Equals(serviceName, StringComparison.OrdinalIgnoreCase))
            {
                Console.WriteLine($"Returning cached {serviceName} object");
                return service;
            }
        }
        return null;
    }

    public void AddService(IService newService)
    {
        bool exists = false;
        foreach (IService service in services)
        {
            if (service.GetName().Equals(newService.GetName(), StringComparison.OrdinalIgnoreCase))
            {
                exists = true;
            }
        }
        if (!exists)
        {
            services.Add(newService);
        }
    }
}

// Service Locator Implementation：服务定位器实现
public class ServiceLocator
{
    private static Cache cache;

    static ServiceLocator()
    {
        cache = new Cache();
    }

    public static IService GetService(string jndiName)
    {
        IService service = cache.GetService(jndiName);
        if (service != null)
        {
            return service;
        }

        InitialContext context = new InitialContext();
        IService service1 = (IService)context.Lookup(jndiName);
        cache.AddService(service1);
        return service1;
    }
}

// Client：客户端
public class ServiceLocatorPatternDemo
{
    public static void Main(string[] args)
    {
        IService service = ServiceLocator.GetService("Service1");
        service.Execute();
        service = ServiceLocator.GetService("Service2");
        service.Execute();
        service = ServiceLocator.GetService("Service1");
        service.Execute();
        service = ServiceLocator.GetService("Service2");
        service.Execute();
    }
}
```

执行该程序后，输出结果：
```
Looking up and creating a new Service1 object
Executing Service1
Looking up and creating a new Service2 object
Executing Service2
Returning cached Service1 object
Executing Service1
Returning cached Service2 object
Executing Service2
```
