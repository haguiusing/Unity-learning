![[读取Excel目录下所有Excel文件#^a9db9b]]

声明2进制数据存储位置路径和真正内容开始的行号
```cs
public static string DATA_BINARY_PATH = Application.streamingAssetsPath + "/Binary/";

public static int BEGIN_INDEX = 4;
```

创建生成excel2进制数据函数，在生成Excel信息的菜单项函数调用
```cs
[MenuItem("GameTool/GenerateExcel")]
private static void GenerateExcelInfo()
{
    ...
    //遍历文件中的所有表的信息
    foreach (DataTable table in tableConllection)
    {
        Debug.Log(table.TableName);
        //生成数据结构类
        GenerateExcelDataClass(table);
        //生成容器类
        GenerateExcelContainer(table);
        //生成2进制数据
        GenerateExcelBinary(table);
    }
}
    

/// <summary>
/// 生成excel2进制数据
/// </summary>
/// <param name="table"></param>
private static void GenerateExcelBinary(DataTable table)
{

}
```

检查二进制路径是否存在，如果不存在则创建二进制路径。创建一个二进制文件进行写入，文件名由表格的名称和后缀组成。写入数据行数（减去4是因为前面4行是配置规则，不是需要记录的数据内容）。存储主键变量名，将字符串转换为字节数组，并写入字节数组的长度和内容。遍历所有数据行，获取每一行的数据。获取类型行，根据类型来决定如何写入数据。根据类型进行相应的写入操作：如果是整数类型，将整数值转换为字节数组，并写入4个字节。如果是浮点数类型，将浮点数值转换为字节数组，并写入4个字节。如果是布尔类型，将布尔值转换为字节数组，并写入1个字节。如果是字符串类型，将字符串转换为字节数组，并依次写入字节数组的长度和内容。关闭文件流。刷新项目窗口。
```cs
private static void GenerateExcelBinary(DataTable table)
{
    // 检查路径是否存在，不存在则创建路径
    if (!Directory.Exists(DATA_BINARY_PATH))
        Directory.CreateDirectory(DATA_BINARY_PATH);

    // 创建一个二进制文件进行写入
    using (FileStream fs = new FileStream(DATA_BINARY_PATH + table.TableName + ".tao", FileMode.OpenOrCreate, FileAccess.Write))
    {
        // 存储具体的excel对应的二进制信息

        // 1. 先存储数据行数，方便读取
        // -4 的原因是前面4行是配置规则，不是我们需要记录的数据内容
        fs.Write(BitConverter.GetBytes(table.Rows.Count - 4), 0, 4);

        // 2. 存储主键变量名
        string keyName = GetVariableNameRow(table)[GetKeyIndex(table)].ToString();//id
        byte[] bytes = Encoding.UTF8.GetBytes(keyName);
        // 存储字符串字节数组的长度
        fs.Write(BitConverter.GetBytes(bytes.Length), 0, 4);
        // 存储字符串字节数组
        fs.Write(bytes, 0, bytes.Length);

        // 遍历所有内容的行进行二进制写入
        DataRow row;
        // 得到类型行，根据类型来决定如何写入数据
        DataRow rowType = GetVariableTypeRow(table);
        for (int i = BEGIN_INDEX; i < table.Rows.Count; i++)
        {
            // 得到一行的数据
            row = table.Rows[i];
            for (int j = 0; j < table.Columns.Count; j++)
            {
                switch (rowType[j].ToString())
                {
                    case "int":
                        fs.Write(BitConverter.GetBytes(int.Parse(row[j].ToString())), 0, 4);
                        break;
                    case "float":
                        fs.Write(BitConverter.GetBytes(float.Parse(row[j].ToString())), 0, 4);
                        break;
                    case "bool":
                        fs.Write(BitConverter.GetBytes(bool.Parse(row[j].ToString())), 0, 1);
                        break;
                    case "string":
                        bytes = Encoding.UTF8.GetBytes(row[j].ToString());
                        // 写入字符串字节数组的长度
                        fs.Write(BitConverter.GetBytes(bytes.Length), 0, 4);
                        // 写入字符串字节数组
                        fs.Write(bytes, 0, bytes.Length);
                        break;
                }
            }
        }

        fs.Close();
    }

    // 刷新Project窗口
    AssetDatabase.Refresh();
}
```

### 查看二进制数据文件是否生成成功
![](https://linwentao785293209.github.io/images/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96/Unity/08.Binary%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE/9.Excel%E8%A1%A8%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6-%E7%94%9F%E6%88%90%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%95%B0%E6%8D%AE%E6%96%87%E4%BB%B6/1.png)

