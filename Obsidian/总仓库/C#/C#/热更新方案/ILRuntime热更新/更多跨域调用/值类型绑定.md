主入口：![[ILRuntimeMain.cs]]

![[Lesson14.cs]]

### 值类型绑定是什么
通过上节课我们知道CLR绑定其实就是把ILRuntime中用到的Unity相关方法进行CLR重定向，让本来要使用反射去执行的一些逻辑变成直接执行。这样可以大大提升我们的性能。
那么值类型绑定，其实就是把Unity当中的一些常用值类型方法进行CLR绑定，比如Vector2、Vector3、Quaternion等。值类型绑定后，性能将得到大幅提升。

### 如何进行值类型绑定
1. 手写值类型绑定类（示例工程中提供了Vector2、Vector3、Quaternion的，可以直接使用）。
2. 注册值类型绑定：
    - `appDomain.RegisterValueTypeBinder(typeof(值类型), new 绑定类())`。
    - 在CLR绑定脚本中注册，在加载dll和pdb后注册。

注意：手写必须了解ILRuntime原理，之后会讲解。

找到示例工程的值类型绑定类，里面其实也是做了一些重定向操作。
![](https://linwentao785293209.github.io/images/%E7%83%AD%E6%9B%B4%E6%96%B0/Unity/ILRuntime/01.ILRuntime%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/15.%E6%9B%B4%E5%A4%9A%E8%B7%A8%E5%9F%9F%E8%B0%83%E7%94%A8-%E5%80%BC%E7%B1%BB%E5%9E%8B%E7%BB%91%E5%AE%9A/1.png)

![](https://linwentao785293209.github.io/images/%E7%83%AD%E6%9B%B4%E6%96%B0/Unity/ILRuntime/01.ILRuntime%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/15.%E6%9B%B4%E5%A4%9A%E8%B7%A8%E5%9F%9F%E8%B0%83%E7%94%A8-%E5%80%BC%E7%B1%BB%E5%9E%8B%E7%BB%91%E5%AE%9A/2.png)

CLR绑定脚本其实自动帮我们进行了值类型绑定注册。但是这只是编辑器下点击生成CLR绑定按钮才调用的。我们等一下要自己加到ILruntime管理器。
![](https://linwentao785293209.github.io/images/%E7%83%AD%E6%9B%B4%E6%96%B0/Unity/ILRuntime/01.ILRuntime%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/15.%E6%9B%B4%E5%A4%9A%E8%B7%A8%E5%9F%9F%E8%B0%83%E7%94%A8-%E5%80%BC%E7%B1%BB%E5%9E%8B%E7%BB%91%E5%AE%9A/3.png)

把值类型绑定注册拷贝到ILruntime管理器的InitILRuntime方法中
```cs
/// <summary>
/// 初始化ILRuntime相关的内容
/// </summary>
unsafe private void InitILRuntime()
{
    //其他初始化
    //委托注册相关  略
    //注册跨域继承的父类适配器 略
   
    // 值类型绑定注册
    appDomain.RegisterValueTypeBinder(typeof(Vector3), new Vector3Binder());
    appDomain.RegisterValueTypeBinder(typeof(Vector2), new Vector2Binder());
    appDomain.RegisterValueTypeBinder(typeof(Quaternion), new QuaternionBinder());
    
    //CLR重定向内容 要写到CLR绑定之前
    //得到想要重定向类的Type
    System.Type debugType = typeof(Debug);
    //得到想要重定向方法的方法信息
    MethodInfo methodInfo = debugType.GetMethod("Log", new System.Type[] { typeof(object) });
    //进行CLR重定向
    appDomain.RegisterCLRMethodRedirection(methodInfo, MyLog);
    
    //注册CLR绑定信息
    ILRuntime.Runtime.Generated.CLRBindings.Initialize(appDomain);
    
    //初始化ILRuntime相关信息（目前只需要告诉ILRuntime主线程的线程ID，主要目的是能够在Unity的Profiler剖析器窗口中分析问题）
    appDomain.UnityMainThreadID = Thread.CurrentThread.ManagedThreadId;
}
```

注册完点击CLR绑定
![](https://linwentao785293209.github.io/images/%E7%83%AD%E6%9B%B4%E6%96%B0/Unity/ILRuntime/01.ILRuntime%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/15.%E6%9B%B4%E5%A4%9A%E8%B7%A8%E5%9F%9F%E8%B0%83%E7%94%A8-%E5%80%BC%E7%B1%BB%E5%9E%8B%E7%BB%91%E5%AE%9A/4.png)

### 性能优化体现
在ILRuntime热更工程中使用Unity中值类型进行计算。不进行值类型绑定的效率较低，进行值类型绑定后性能将大幅提升。

ILRuntimeMain添加值类型十万次运算的逻辑，重新生成
```cs
System.DateTime currentTime = System.DateTime.Now;
Vector3 v1 = new Vector3(123, 54, 567);
Vector3 v2 = new Vector3(342, 678, 123);
float dot = 0;
for (int i = 0; i < 100000; i++)
{
    dot += Vector3.Dot(v1, v2);
}

Vector2 v3 = new Vector2(12, 56);
Vector2 v4 = new Vector2(123123, 45345);
for (int i = 0; i < 100000; i++)
{
    dot += Vector3.Dot(v3, v4);
}

Debug.Log("值类型计算花费的时间：" + (System.DateTime.Now - currentTime).TotalMilliseconds + "ms");
```

先暂时注释掉ILruntime管理器的值类型绑定代码，运行查看时间(66ms)
```cs
// // 值类型绑定注册
// appDomain.RegisterValueTypeBinder(typeof(Vector3), new Vector3Binder());
// appDomain.RegisterValueTypeBinder(typeof(Vector2), new Vector2Binder());
// appDomain.RegisterValueTypeBinder(typeof(Quaternion), new QuaternionBinder());
```

解开注释再运行，可以看到性能有一定提升(53ms)
```cs
// 值类型绑定注册
appDomain.RegisterValueTypeBinder(typeof(Vector3), new Vector3Binder());
appDomain.RegisterValueTypeBinder(typeof(Vector2), new Vector2Binder());
appDomain.RegisterValueTypeBinder(typeof(Quaternion), new QuaternionBinder());
```

### 总结
值类型绑定，就是把Unity当中的一些常用值类型方法进行CLR绑定。他可以大幅提高在热更新工程中使用Unity中值类型对象的效率。