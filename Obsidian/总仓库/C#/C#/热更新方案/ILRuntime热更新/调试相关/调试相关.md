![[Lesson19.cs]]


### 准备ILRuntime调试相关插件
1. ILRuntime 2.1.0以下的版本需要前往ILRuntime的Github页面获取插件，地址：[https://github.com/Ourpalm/ILRuntime](https://github.com/Ourpalm/ILRuntime)。打开页面后，点击右侧的Releases，往下拉会看到很多2.1.0之前的版本，在对应版本处点开Asset，下载调试插件ILRuntimeDebuggerLauncher.vsix。
    
2. ILRuntime 2.1.0及其以上的版本在VS上方的拓展-管理拓展-搜索ILRuntime Debugger后安装。或者在rider中搜索ILRuntime Debugger插件，或者直接去以下网址：[https://plugins.jetbrains.com/plugin/19528-ilruntime-debugger](https://plugins.jetbrains.com/plugin/19528-ilruntime-debugger)。

下载安装成功后重启IDE，可以看到调试是有附加到ILruntime。

### 断点调试的必备工作
步骤概述：
1. 在初始化处注册调试服务：`appDomain.DebugService.StartDebugService(端口号)`。
2. 通过协同程序，等待调试器链接（否则我们无法对一开始的逻辑进行断点）。判断调试器链接的API为`appDomain.DebugService.IsDebuggerAttached`。

注意：一般只有在开发周期才会这样去处理。如果最终发布了，就不用启动我们的调试服务，也不用去通过协程延迟执行后面的逻辑。

去ILruntime管理器InitILRuntime启动调试服务，注意卸载初始化函数的最后，在初始化ILRuntime主线程的线程ID后
```cs
// 启动调试服务
appDomain.DebugService.StartDebugService(56000);
```

在ILruntimeMain随便添加一行调试代码。
如果想要在ILruntimeMain热更工程断点调试，要必须保证Unity工程或者项目已经启动才能在ILruntimeMain热更工程附加ILruntime进行调试，所以一定要先运行了游戏再去附加调试，但是直接一启动就来不及了。
```cs
// 如果想要在ILruntimeMain热更工程断点调试，要必须保证Unity工程或者项目已经启动才能在ILruntimeMain热更工程附加ILruntime进行调试
// 所以一定要先运行了游戏再去附加调试，但是直接一启动就来不及了
Debug.Log(123);
```

为了解决一启动来不及附加的问题，修改ilruntimeManager，添加协程，让回调在协程中运行，在之前使用appDomain.DebugService.IsDebuggerAttached判断是否附加调试
```cs
/// <summary>
/// 去异步加载我们的热更相关的dll和pdb文件
/// </summary>
/// <returns></returns>
IEnumerator LoadHotUpdateInfo(UnityAction callBack)
{

    //...
    //将我们两个文件的内存流用于初始化 appDomain 我们之后就可以通过该对象来执行我们对应的热更代码了
    appDomain.LoadAssembly(dllStream, pdbStream, new PdbReaderProvider());

    InitILRuntime();

    StartCoroutine(WaitDebugger(callBack));
}

IEnumerator WaitDebugger(UnityAction callBack)
{
    //不停判断是否有调试器接入 如果false一直等待
    //直到为true 代表有调试器接入
    while (!appDomain.DebugService.IsDebuggerAttached)
    {
        yield return null;
    }

    ILRuntimeLoadOverDoSomthing();

    //当ILRuntime启动完毕 想要在外部执行的内容
    callBack?.Invoke();
}
```

但是我们只有在开发模式才这样处理，我们可以添加是否是开发模式标识
```cs
private bool isDebug = true;

/// <summary>
/// 初始化ILRuntime相关的内容
/// </summary>
unsafe private void InitILRuntime()
{
    //...
    if (isDebug)
    {
        //启动调试服务
        appDomain.DebugService.StartDebugService(56000);
    }
}

/// <summary>
/// 去异步加载我们的热更相关的dll和pdb文件
/// </summary>
/// <returns></returns>
IEnumerator LoadHotUpdateInfo(UnityAction callBack)
{
    ...
    InitILRuntime();

    if (isDebug)
    {
        StartCoroutine(WaitDebugger(callBack));
    }
    else
    {
        ILRuntimeLoadOverDoSomthing();

        //当ILRuntime启动完毕 想要在外部执行的内容
        callBack?.Invoke();
    }
}

IEnumerator WaitDebugger(UnityAction callBack)
{
    print("等到调试器接入");
    //不停判断是否有调试器接入 如果false一直等待
    //直到为true 代表有调试器接入
    while (!appDomain.DebugService.IsDebuggerAttached)
    {
        yield return null;
    }

    print("调试器接入成功");
    yield return new WaitForSeconds(1f);

    ILRuntimeLoadOverDoSomthing();

    //当ILRuntime启动完毕 想要在外部执行的内容
    callBack?.Invoke();
}
```

### 进行断点调试
断点概述
在ILruntimeMain热更工程的 调试页签中 选择 Attach to ILRuntime，即可开始断点调试。

注意：
1. 附加到ILRuntime后，弹出窗口中填写的内容为IP地址和端口号，意味着我们可以调试各种设备，只要保证IP地址和端口号正确即可。
2. 如果ILRuntime相关的dll和pdb文件没有加载成功，调试会失败。

isDebug改成true，再运行Unity，在ILruntimeMain热更工程中选择 Attach to ILRuntime，如果附加不上尝试重新生成ILruntimeMain热更工程后重来

### 总结
1. 进行ILRuntime调试需要安装插件。
    
2. 想要进行断点调试，我们需要注册调试服务。想要及时进断点，那么可以配合协同程序等待调试器链接。
    
3. 可以利用IP和端口调试特点来调试移动设备(内网环境)。